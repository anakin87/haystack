name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v2.99.0-rc1 or v2.99.0)'
        required: true
        type: string

jobs:
  parse-validate-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.parse-validate.outputs.version }}
      major_minor: ${{ steps.parse-validate.outputs.major_minor }}
      release_branch: ${{ steps.parse-validate.outputs.release_branch }}
      is_first_rc: ${{ steps.parse-validate.outputs.is_first_rc }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Parse and validate version
        id: parse-validate
        env:
          GH_TOKEN: ${{ github.token }}
        run: .github/utils/parse_validate_version.sh "${{ inputs.version }}"

  branch-off:
    if: needs.parse-validate-version.outputs.is_first_rc == 'true'
    needs: parse-validate-version
    uses: ./.github/workflows/branch_off.yml
    with:
      version: ${{ needs.parse-validate-version.outputs.major_minor }}

  release:
    needs: ["parse-validate-version", "branch-off"]
    if: always() && needs.parse-validate-version.result == 'success' && needs.branch-off.result != 'failure'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout release branch
        run: |
          git checkout ${{ needs.parse-validate-version.outputs.release_branch }}
          git pull origin ${{ needs.parse-validate-version.outputs.release_branch }}

      - name: Update VERSION.txt and create tag
        run: |
          echo "${{ needs.parse-validate-version.outputs.version }}" > VERSION.txt
          git add VERSION.txt
          git commit -m "bump version to ${{ needs.parse-validate-version.outputs.version }}"
          git push origin ${{ needs.parse-validate-version.outputs.release_branch }}

          TAG="v${{ needs.parse-validate-version.outputs.version }}"
          git tag -m "$TAG" "$TAG"
          git push origin "$TAG"

  check-artifacts:
    needs: ["parse-validate-version", "release"]
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      # TODO: Remove this hardcoded version once testing on the main repo.
      # On the fork, we can't push real releases, so we use an existing version for testing.
      # In production, use: VERSION: ${{ needs.parse-validate-version.outputs.version }}
      VERSION: "2.19.0"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Wait for release workflows
        run: |
          .github/utils/wait_for_release_workflows.sh "v${{ env.VERSION }}" \
            "Project release on PyPi" \
            "Project release on Github" \
            "Docker image release"

      - name: Check GitHub Release
        run: |
          gh api "repos/${{ github.repository }}/releases/tags/v${{ env.VERSION }}" > /dev/null || {
            echo "‚ùå GitHub Release not found"
            exit 1
          }
          echo "‚úÖ GitHub Release exists"

      - name: Check PyPI
        run: |
          curl -sf "https://pypi.org/pypi/haystack-ai/${{ env.VERSION }}/json" > /dev/null || {
            echo "‚ùå PyPI package not found"
            exit 1
          }
          echo "‚úÖ PyPI package exists"

      - name: Check Docker Hub
        run: |
          curl -sf "https://hub.docker.com/v2/repositories/deepset/haystack/tags/base-v${{ env.VERSION }}" > /dev/null || {
            echo "‚ùå Docker image not found"
            exit 1
          }
          echo "‚úÖ Docker image exists"

      - name: Summary
        run: |
          echo ""
          echo "=========================================="
          echo "üéâ Release v${{ env.VERSION }} verified!"
          echo "=========================================="
          echo ""
          echo "üì¶ Artifacts:"
          echo "   ‚Ä¢ GitHub: https://github.com/${{ github.repository }}/releases/tag/v${{ env.VERSION }}"
          echo "   ‚Ä¢ PyPI:   https://pypi.org/project/haystack-ai/${{ env.VERSION }}/"
          echo "   ‚Ä¢ Docker: https://hub.docker.com/r/deepset/haystack/tags?name=base-v${{ env.VERSION }}"
          echo ""
