name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v2.99.0-rc1 or v2.99.0)'
        required: true
        type: string

jobs:
  parse-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.parse.outputs.version }}
      major_minor: ${{ steps.parse.outputs.major_minor }}
      release_branch: ${{ steps.parse.outputs.release_branch }}
      is_minor: ${{ steps.parse.outputs.is_minor }}
      is_rc: ${{ steps.parse.outputs.is_rc }}
      is_first_rc: ${{ steps.parse.outputs.is_first_rc }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Parse version
        id: parse
        run: |
          OUTPUT=$(python3 .github/utils/parse_version.py "${{ inputs.version }}")
          echo "$OUTPUT" >> "$GITHUB_OUTPUT"


  branch-off:
    if: needs.parse-version.outputs.is_first_rc == 'true'
    needs: parse-version
    uses: ./.github/workflows/branch_off.yml
    with:
      version: ${{ needs.parse-version.outputs.major_minor }}

  release:
    needs: ["parse-version", "branch-off"]
    if: always() && needs.parse-version.result == 'success' && needs.branch-off.result != 'failure'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout release branch
        run: |
          git checkout ${{ needs.parse-version.outputs.release_branch }}
          git pull origin ${{ needs.parse-version.outputs.release_branch }}

      - name: For final releases, check rc is present and successfully tested
        if: needs.parse-version.outputs.is_rc == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.parse-version.outputs.version }}"
          
          # Search for valid RC tags (excluding rc0), sorted numerically
          RC_TAGS=$(git tag -l "v${VERSION}-rc*" | grep -v "rc0$" || true)
          
          if [ -z "$RC_TAGS" ]; then
            echo "Error: No valid RC tag found for version ${VERSION}"
            echo "Before releasing a final version, at least one RC tag (e.g., v${VERSION}-rc1, v${VERSION}-rc2) must exist."
            echo "Note: rc0 does not count as a valid RC."
            exit 1
          fi
          
          echo "Found valid RC tags: $RC_TAGS"
          
          # Get the last RC tag
          LAST_RC=$(echo "$RC_TAGS" | sort -V | tail -n1)
          echo "Last RC tag: $LAST_RC"
          
          # Get the commit SHA for the RC tag
          RC_SHA=$(git rev-list -n 1 "$LAST_RC")
          echo "RC tag $LAST_RC points to commit: $RC_SHA"
          
          # Check for successful test workflow runs on this commit
          WORKFLOW_RUNS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/runs?head_sha=$RC_SHA&status=success" \
            --jq '.workflow_runs[] | select(.name == "Tests") | .conclusion')
          
          if [ -z "$WORKFLOW_RUNS" ]; then
            echo "Error: No successful 'Tests' workflow run found for RC tag $LAST_RC (commit $RC_SHA)"
            echo "Before releasing a final version, the Tests workflow must run successfully on the last RC."
            exit 1
          fi
          
          echo "âœ“ Tests workflow ran successfully on $LAST_RC"

      - name: Update VERSION.txt and create tag
        run: |
          echo "${{ needs.parse-version.outputs.version }}" > VERSION.txt
          git add VERSION.txt
          git commit -m "bump version to ${{ needs.parse-version.outputs.version }}"
          git push origin ${{ needs.parse-version.outputs.release_branch }}
          
          TAG="v${{ needs.parse-version.outputs.version }}"
          git tag -m "$TAG" "$TAG"
          git push origin "$TAG"